#!/usr/bin/env ruby
# Script para executar mutation testing com Mutant

require 'bundler/setup'

# Carregar ambiente Rails primeiro
require File.expand_path('../config/environment', __dir__)

# Verificar se estamos no ambiente de teste
unless Rails.env.test?
  puts "âŒ Erro: Mutant deve ser executado no ambiente de teste"
  puts "Execute: RAILS_ENV=test bin/mutant"
  exit 1
end

puts "ğŸ§¬ Iniciando Mutation Testing com Mutant"
puts "=" * 50

# OpÃ§Ãµes de execuÃ§Ã£o baseadas nos argumentos
target = ARGV[0]
options = ARGV[1..-1]

case target.downcase
when 'models'
  puts "ğŸ” Testando mutaÃ§Ãµes nos Modelos..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- User Group Payment Expense GroupMembership ExpenseParticipant")
  
when 'services'
  puts "âš™ï¸ Testando mutaÃ§Ãµes nos ServiÃ§os..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- BalanceCalculator BalanceAggregator SettlementOptimizer SplitRuleEngine TransactionSimplifier")
  
when 'user'
  puts "ğŸ‘¤ Testando mutaÃ§Ãµes no User model..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'User'")
  
when 'payment'
  puts "ğŸ’° Testando mutaÃ§Ãµes no Payment model..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'Payment'")
  
when 'expense'
  puts "ğŸ§¾ Testando mutaÃ§Ãµes no Expense model..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'Expense'")
  
when 'split_engine'
  puts "âš¡ Testando mutaÃ§Ãµes no SplitRuleEngine..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'SplitRuleEngine'")

when 'balance_calculator'
  puts "ğŸ§® Testando mutaÃ§Ãµes no BalanceCalculator..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'BalanceCalculator'")

when 'balance_aggregator'
  puts "ğŸ“Š Testando mutaÃ§Ãµes no BalanceAggregator..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'BalanceAggregator'")

when 'settlement_optimizer'
  puts "ğŸ¯ Testando mutaÃ§Ãµes no SettlementOptimizer..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'SettlementOptimizer'")

when 'transaction_simplifier'
  puts "ğŸ”„ Testando mutaÃ§Ãµes no TransactionSimplifier..."
  system("bundle exec mutant run --usage opensource --integration rspec -I . -r config/environment -- 'TransactionSimplifier'")
  
when 'help', '--help', '-h'
  puts <<~HELP
    ğŸ§¬ Mutant - Mutation Testing Script
    
    Uso:
      bin/mutant [alvo] [opÃ§Ãµes]
    
    Alvos disponÃ­veis:
      models              - Testa todos os modelos
      services            - Testa todos os serviÃ§os
      user                - Testa apenas o User model
      payment             - Testa apenas o Payment model
      expense             - Testa apenas o Expense model
      balance_calculator   - Testa apenas o BalanceCalculator
      balance_aggregator   - Testa apenas o BalanceAggregator
      settlement_optimizer - Testa apenas o SettlementOptimizer
      split_rule_engine    - Testa apenas o SplitRuleEngine
      transaction_simplifier - Testa apenas o TransactionSimplifier
    
    Exemplos:
      bin/mutant models
      bin/mutant services
      bin/mutant user
      bin/mutant transaction_simplifier
      bin/mutant balance_calculator
    
    O que Ã© Mutation Testing?
    Mutation testing modifica o cÃ³digo fonte (mutaÃ§Ãµes) para verificar
    se os testes detectam essas mudanÃ§as. Se uma mutaÃ§Ã£o sobrevive,
    significa que os testes nÃ£o sÃ£o bons o suficiente.
    
    ğŸ”´ MutaÃ§Ã£o sobrevivente = Testes fracos
    ğŸŸ¢ MutaÃ§Ã£o morta = Testes fortes
  HELP
  
else
  puts "ğŸ” Testando mutaÃ§Ãµes em todo o cÃ³digo..."
  puts "Isso pode levar vÃ¡rios minutos... â³"
  system("bundle exec mutant run --usage opensource --integration rspec")
end

puts "\nâœ… Mutation testing concluÃ­do!"
puts "ğŸ“Š Verifique o resultado acima para mutaÃ§Ãµes sobreviventes."
puts "ğŸ”´ MutaÃ§Ãµes sobreviventes indicam testes que precisam melhorar."
